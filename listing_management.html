<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ëŒ€ì¶œëœë“œ - ë¦¬ìŠ¤íŒ… ê´€ë¦¬</title>
    <style>
        body { font-family: 'Malgun Gothic', sans-serif; background: #f8f9fa; padding: 20px; color: #333; }
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        h2 { text-align: center; color: #007bff; margin-bottom: 30px; }
        .back-btn { display: inline-block; padding: 10px 15px; background: #6c757d; color: white; border-radius: 5px; text-decoration: none; margin-top: 20px;}
        .back-btn:hover { background: #5a6268; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        button { padding: 5px 10px; border: none; border-radius: 5px; cursor: pointer; }
        .edit-btn { background: #007bff; color: white; }
        .delete-btn { background: #dc3545; color: white; }
        .modal { display: none; position: fixed; z-index: 1; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 700px; border-radius: 10px; }
        .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; }
        .close:hover, .close:focus { color: black; text-decoration: none; cursor: pointer; }
        .modal-body { max-height: 60vh; overflow-y: auto; }
        label { display: block; font-size: 13px; color: #666; margin-bottom: 5px; margin-top: 10px; }
        input, textarea, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 14px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
    </style>
</head>
<body>
    <div class="container">
        <h2>ğŸ“Š ë“±ë¡ëœ ë¦¬ìŠ¤íŒ… ê´€ë¦¬</h2>
        <div id="listingsTableContainer"></div>
        <a href="admin.html" class="back-btn">â¬…ï¸ ê´‘ê³  ë“±ë¡ í˜ì´ì§€ë¡œ ëŒì•„ê°€ê¸°</a>
    </div>

    <!-- The Modal -->
    <div id="editModal" class="modal">
      <div class="modal-content">
        <span class="close">&times;</span>
        <h2>ë¦¬ìŠ¤íŒ… ìˆ˜ì •</h2>
        <div class="modal-body">
            <input type="hidden" id="edit-docId">
            <label>ë©”ì¸ ê´‘ê³  ì œëª©</label>
            <input type="text" id="edit-title">
            <h3>ğŸ¢ ì—…ì²´ì •ë³´</h3>
            <label>ì—…ì²´ëª…</label>
            <input type="text" id="edit-companyName">
            <label>ì—°ë½ì²˜</label>
            <input type="text" id="edit-phone">
            <label>ë“±ë¡ë²ˆí˜¸</label>
            <input type="text" id="edit-regNumber">
            <label>ë“±ë¡ê¸°ê´€</label>
            <input type="text" id="edit-agency">
            <label>ì˜ì—…ì†Œ ì£¼ì†Œ</label>
            <input type="text" id="edit-address">
            <h3>ğŸ’° ìƒí’ˆì •ë³´</h3>
            <div class="grid">
                <div><label>ì›” ê¸ˆë¦¬</label><input type="text" id="edit-monthlyRate"></div>
                <div><label>ì—° ê¸ˆë¦¬</label><input type="text" id="edit-yearlyRate"></div>
                <div><label>ëŒ€ì¶œí•œë„</label><input type="text" id="edit-limit"></div>
                <div><label>ìƒí™˜ë°©ì‹</label><input type="text" id="edit-repayment"></div>
                <div><label>ìƒí™˜ê¸°ê°„</label><input type="text" id="edit-period"></div>
                <div><label>ì—°ì²´ê¸ˆë¦¬</label><input type="text" id="edit-overdueRate"></div>
                <div><label>ì¶”ê°€ë¹„ìš©</label><input type="text" id="edit-extraFee"></div>
                <div><label>ì¤‘ë„ìƒí™˜ìˆ˜ìˆ˜ë£Œ</label><input type="text" id="edit-prepayFee"></div>
            </div>
            <label for="edit-region">ê°€ëŠ¥ ì§€ì—­</label>
            <select id="edit-region">
                <option value="ì „êµ­">ì „êµ­</option>
                <option value="ì„œìš¸">ì„œìš¸</option>
                <option value="ê²½ê¸°">ê²½ê¸°</option>
                <option value="ì¸ì²œ">ì¸ì²œ</option>
                <option value="ë¶€ì‚°">ë¶€ì‚°</option>
                <option value="ëŒ€êµ¬">ëŒ€êµ¬</option>
                <option value="ê´‘ì£¼">ê´‘ì£¼</option>
                <option value="ëŒ€ì „">ëŒ€ì „</option>
            </select>
            <label for="edit-loanType">ìƒí’ˆ ì¢…ë¥˜</label>
            <select id="edit-loanType">
                <option value="ì†Œì•¡ëŒ€ì¶œ">ì†Œì•¡ëŒ€ì¶œ</option>
                <option value="ì§ì¥ì¸">ì§ì¥ì¸</option>
                <option value="ì‚¬ì—…ì">ì‚¬ì—…ì</option>
                <option value="ì €ì‹ ìš©">ì €ì‹ ìš©</option>
                <option value="ë‹¹ì¼ëŒ€ì¶œ">ë‹¹ì¼ëŒ€ì¶œ</option>
            </select>
        </div>
        <div style="text-align: right; margin-top: 20px;">
            <button id="updateBtn" class="edit-btn">ì™„ë£Œ</button>
            <button id="deleteBtn" class="delete-btn">ë§¤ë¬¼ ì‚­ì œ</button>
        </div>
      </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, getDoc, updateDoc, deleteDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAYd6PZFWAoXDnz80l_1-0EDtkDxAkQFy4",
            authDomain: "laos-project-ff295.firebaseapp.com",
            projectId: "laos-project-ff295",
            storageBucket: "laos-project-ff295.firebasestorage.app",
            messagingSenderId: "7764846397",
            appId: "1:7764846397:web:8977b486e092c0f7d24754",
            measurementId: "G-LMD3B020W7"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const modal = document.getElementById("editModal");
        const span = document.getElementsByClassName("close")[0];

        span.onclick = function() {
          modal.style.display = "none";
        }

        window.onclick = function(event) {
          if (event.target == modal) {
            modal.style.display = "none";
          }
        }

        async function loadListings() {
            const listingsContainer = document.getElementById('listingsTableContainer');
            listingsContainer.innerHTML = '<p style="text-align: center;">ë¦¬ìŠ¤íŒ…ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>';

            try {
                const adsCollection = collection(db, "ads");
                const q = query(adsCollection, orderBy("created_at", "desc"));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    listingsContainer.innerHTML = '<p style="text-align: center;">ë“±ë¡ëœ ë¦¬ìŠ¤íŒ…ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                    return;
                }

                let tableHtml = '<table><thead><tr><th>ì œëª©</th><th>ì—…ì²´ëª…</th><th>ë“±ë¡ì¼</th><th>ì•¡ì…˜</th></tr></thead><tbody>';
                querySnapshot.forEach(doc => {
                    const ad = doc.data();
                    const date = ad.created_at ? new Date(ad.created_at.toDate()).toLocaleString() : 'N/A';
                    tableHtml += `
                        <tr>
                            <td>${ad.title || 'N/A'}</td>
                            <td>${ad.company_name || 'N/A'}</td>
                            <td>${date}</td>
                            <td><button class="edit-btn" onclick="viewDetails('${doc.id}')">ìƒì„¸ë³´ê¸°</button></td>
                        </tr>
                    `;
                });
                tableHtml += '</tbody></table>';
                listingsContainer.innerHTML = tableHtml;

            } catch (e) {
                console.error("ë¦¬ìŠ¤íŒ… ë¡œë”© ì‹¤íŒ¨: ", e);
                listingsContainer.innerHTML = '<p style="text-align: center; color: red;">ë¦¬ìŠ¤íŒ…ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>';
            }
        }
        
        window.viewDetails = async (id) => {
            const docRef = doc(db, "ads", id);
            const docSnap = await getDoc(docRef);

            if (docSnap.exists()) {
                const ad = docSnap.data();
                document.getElementById('edit-docId').value = id;
                document.getElementById('edit-title').value = ad.title || '';
                document.getElementById('edit-companyName').value = ad.company_name || '';
                document.getElementById('edit-phone').value = ad.phone || '';
                document.getElementById('edit-regNumber').value = ad.reg_number || '';
                document.getElementById('edit-agency').value = ad.agency || '';
                document.getElementById('edit-address').value = ad.address || '';
                document.getElementById('edit-monthlyRate').value = ad.monthly_rate || '';
                document.getElementById('edit-yearlyRate').value = ad.yearly_rate || '';
                document.getElementById('edit-limit').value = ad.limit || '';
                document.getElementById('edit-repayment').value = ad.repayment || '';
                document.getElementById('edit-period').value = ad.period || '';
                document.getElementById('edit-overdueRate').value = ad.overdue_rate || '';
                document.getElementById('edit-extraFee').value = ad.extra_fee || '';
                document.getElementById('edit-prepayFee').value = ad.prepay_fee || '';
                document.getElementById('edit-region').value = ad.region || 'ì „êµ­';
                document.getElementById('edit-loanType').value = ad.loan_type || 'ì†Œì•¡ëŒ€ì¶œ';
                
                modal.style.display = "block";
            } else {
                alert("í•´ë‹¹ ë¦¬ìŠ¤íŒ…ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            }
        };

        document.getElementById('updateBtn').addEventListener('click', async () => {
            const docId = document.getElementById('edit-docId').value;
            if (!docId) {
                alert("ì˜¤ë¥˜: ë¬¸ì„œ IDë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }

            const adData = {
                title: document.getElementById('edit-title').value,
                company_name: document.getElementById('edit-companyName').value,
                phone: document.getElementById('edit-phone').value,
                reg_number: document.getElementById('edit-regNumber').value,
                agency: document.getElementById('edit-agency').value,
                address: document.getElementById('edit-address').value,
                monthly_rate: document.getElementById('edit-monthlyRate').value,
                yearly_rate: document.getElementById('edit-yearlyRate').value,
                limit: document.getElementById('edit-limit').value,
                repayment: document.getElementById('edit-repayment').value,
                period: document.getElementById('edit-period').value,
                overdue_rate: document.getElementById('edit-overdueRate').value,
                extra_fee: document.getElementById('edit-extraFee').value,
                prepay_fee: document.getElementById('edit-prepayFee').value,
                region: document.getElementById('edit-region').value,
                loan_type: document.getElementById('edit-loanType').value,
            };

            try {
                const docRef = doc(db, "ads", docId);
                await updateDoc(docRef, adData);
                alert("âœ… ë¦¬ìŠ¤íŒ…ì´ ì„±ê³µì ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤!");
                modal.style.display = "none";
                loadListings();
            } catch (e) {
                console.error("ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ", e);
                alert("âŒ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨!");
            }
        });

        document.getElementById('deleteBtn').addEventListener('click', async () => {
            const docId = document.getElementById('edit-docId').value;
            if (!docId) {
                alert("ì˜¤ë¥˜: ë¬¸ì„œ IDë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }

            if (confirm("ì •ë§ë¡œ ì´ ë¦¬ìŠ¤íŒ…ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                try {
                    await deleteDoc(doc(db, "ads", docId));
                    alert("ğŸ—‘ï¸ ë¦¬ìŠ¤íŒ…ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                    modal.style.display = "none";
                    loadListings();
                } catch (e) {
                    console.error("ì‚­ì œ ì‹¤íŒ¨: ", e);
                    alert("âŒ ì‚­ì œ ì‹¤íŒ¨!");
                }
            }
        });

        document.addEventListener('DOMContentLoaded', loadListings);
    </script>
</body>
</html>